branch modified by Lasse to enable complex features
